// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MANAGEMENT ====================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     DateTime?
  firstName         String
  lastName          String
  passwordHash      String?
  phone             String?
  profileImage      String?
  
  // OAuth
  accounts          Account[]
  sessions          Session[]
  
  // App Data
  tabs              Tab[]
  paymentMethods    PaymentMethod[]
  notifications     Notification[]
  ratings           Rating[]
  
  // Preferences
  defaultTipPercent Int       @default(18)
  pushNotifications Boolean   @default(true)
  emailNotifications Boolean  @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== VENUES ====================

model Venue {
  id              String   @id @default(cuid())
  name            String
  address         String
  city            String
  state           String
  zipCode         String
  phone           String
  email           String
  
  // Location
  latitude        Float
  longitude       Float
  
  // Business Info
  merchantId      String   @unique
  taxRate         Float    @default(0.08)
  
  // Features
  logo            String?
  coverImage      String?
  description     String?
  
  // Operating Hours
  openingHours    Json     // { monday: { open: "11:00", close: "23:00" }, ... }
  
  // Relationships
  tables          Table[]
  menuCategories  MenuCategory[]
  tabs            Tab[]
  ratings         Rating[]
  
  // Status
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("venues")
}

model Table {
  id              String   @id @default(cuid())
  venueId         String
  tableNumber     String
  qrCode          String   @unique // Encoded: bartab://venue/{venueId}/table/{tableNumber}
  capacity        Int
  
  // Relationships
  venue           Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  tabs            Tab[]
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([venueId, tableNumber])
  @@map("tables")
}

// ==================== MENU ====================

model MenuCategory {
  id              String     @id @default(cuid())
  venueId         String
  name            String     // Drinks, Starters, Mains, Desserts
  description     String?
  sortOrder       Int        @default(0)
  
  // Relationships
  venue           Venue      @relation(fields: [venueId], references: [id], onDelete: Cascade)
  items           MenuItem[]
  
  isActive        Boolean    @default(true)
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@map("menu_categories")
}

model MenuItem {
  id              String       @id @default(cuid())
  categoryId      String
  name            String
  description     String
  price           Float
  image           String?
  
  // Details
  allergens       String[]     // ["dairy", "gluten", "nuts"]
  isVegetarian    Boolean      @default(false)
  isVegan         Boolean      @default(false)
  isGlutenFree    Boolean      @default(false)
  
  // Availability
  isAvailable     Boolean      @default(true)
  availableDays   String[]     // ["monday", "tuesday", ...]
  availableHours  Json?        // { start: "17:00", end: "22:00" }
  
  // Relationships
  category        MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems      OrderItem[]
  
  sortOrder       Int          @default(0)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("menu_items")
}

// ==================== TABS & ORDERS ====================

model Tab {
  id              String     @id @default(cuid())
  userId          String
  venueId         String
  tableId         String
  
  // Status
  status          TabStatus  @default(OPEN)
  
  // Financial
  subtotal        Float      @default(0)
  tax             Float      @default(0)
  tip             Float      @default(0)
  total           Float      @default(0)
  
  // Timing
  openedAt        DateTime   @default(now())
  closedAt        DateTime?
  
  // Relationships
  user            User       @relation(fields: [userId], references: [id])
  venue           Venue      @relation(fields: [venueId], references: [id])
  table           Table      @relation(fields: [tableId], references: [id])
  orders          Order[]
  splits          TabSplit[]
  payment         Payment?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@map("tabs")
}

enum TabStatus {
  OPEN
  CLOSED
  CANCELLED
}

model Order {
  id              String       @id @default(cuid())
  tabId           String
  
  // Status
  status          OrderStatus  @default(PENDING)
  
  // Items
  items           OrderItem[]
  
  // Timing
  orderedAt       DateTime     @default(now())
  preparedAt      DateTime?
  deliveredAt     DateTime?
  
  // Notes
  specialInstructions String?
  
  // Relationships
  tab             Tab          @relation(fields: [tabId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("orders")
}

enum OrderStatus {
  PENDING      // Just ordered
  CONFIRMED    // Kitchen received
  PREPARING    // Being made
  READY        // Ready to serve
  DELIVERED    // Delivered to table
  CANCELLED    // Cancelled
}

model OrderItem {
  id              String    @id @default(cuid())
  orderId         String
  menuItemId      String
  
  quantity        Int       @default(1)
  price           Float     // Price at time of order
  notes           String?
  
  // Relationships
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem        MenuItem  @relation(fields: [menuItemId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("order_items")
}

// ==================== PAYMENTS ====================

model TabSplit {
  id              String   @id @default(cuid())
  tabId           String
  userId          String?  // null if guest
  guestName       String?
  
  amount          Float
  tip             Float
  total           Float
  
  isPaid          Boolean  @default(false)
  
  // Relationships
  tab             Tab      @relation(fields: [tabId], references: [id], onDelete: Cascade)
  payment         Payment?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("tab_splits")
}

model Payment {
  id                String        @id @default(cuid())
  tabId             String        @unique
  tabSplitId        String?       @unique
  userId            String
  
  // Amount
  amount            Float
  currency          String        @default("USD")
  
  // Payment Method
  paymentMethodId   String?
  paymentMethod     PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  
  // Provider Details
  stripePaymentId   String?       @unique
  status            PaymentStatus @default(PENDING)
  
  // Relationships
  tab               Tab           @relation(fields: [tabId], references: [id])
  tabSplit          TabSplit?     @relation(fields: [tabSplitId], references: [id])
  
  // Metadata
  receiptUrl        String?
  failureReason     String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

model PaymentMethod {
  id              String    @id @default(cuid())
  userId          String
  
  // Card Details
  type            String    // "card", "apple_pay"
  brand           String?   // "visa", "mastercard"
  last4           String
  expiryMonth     Int?
  expiryYear      Int?
  
  // Stripe
  stripePaymentMethodId String @unique
  
  // Settings
  isDefault       Boolean   @default(false)
  
  // Relationships
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments        Payment[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("payment_methods")
}

// ==================== NOTIFICATIONS & RATINGS ====================

model Notification {
  id              String           @id @default(cuid())
  userId          String
  
  type            NotificationType
  title           String
  message         String
  data            Json?            // Additional data
  
  isRead          Boolean          @default(false)
  readAt          DateTime?
  
  // Relationships
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime         @default(now())
  
  @@map("notifications")
}

enum NotificationType {
  ORDER_CONFIRMED
  ORDER_READY
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TAB_CLOSED
  PROMOTION
}

model Rating {
  id              String   @id @default(cuid())
  userId          String
  venueId         String
  tabId           String?
  
  rating          Int      // 1-5 stars
  review          String?
  
  // Relationships
  user            User     @relation(fields: [userId], references: [id])
  venue           Venue    @relation(fields: [venueId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("ratings")
}

